services:
  # 1. LangGraph API 서버
  langgraph-api:
    # Dockerfile에서 빌드한 이미지와 태그를 일치시킵니다.
    # 1. 빌드 설정 추가: 현재 폴더(.)의 Dockerfile을 사용함
    build: .
    # 2. 빌드 후 생성될 이미지 이름을 지정
    image: my-langgraph-app:v7
    ports:
      - "8123:8123"
    environment:
      # [데이터베이스] DATABASE_URI와 REDIS_URI는 필수입니다.
      - DATABASE_URI=postgres://postgres:1234@postgres:5432/postgres
      - LANGGRAPH_POSTGRES_URI=postgres://postgres:1234@postgres:5432/postgres
      - REDIS_URI=redis://redis:6379

      # [API 키] 사용 중인 에이전트 도구에 맞춰 추가하세요.
      - GROQ_API_KEY=${GROQ_API_KEY}
      - TAVILY_API_KEY=${TAVILY_API_KEY}
      
      # [라이선스/디버깅] 
      - LANGSMITH_API_KEY=${LANGSMITH_API_KEY} 
      - LOG_LEVEL=debug
      - LANGGRAPH_DEBUG=1

      # [경로 설정] ModuleNotFoundError를 방지하기 위해 중요합니다.
      - PYTHONPATH=/deps/app

      # 대기 시간을 120초로 늘려줍니다.
      - LANGGRAPH_GRPC_READY_TIMEOUT=120

      # 서버가 외부의 모든 요청을 받아들일 수 있도록 호스트 강제 지정
      - HOST=0.0.0.0
      - PORT=8123

    # [볼륨 마운트] 
    # 개발 단계에서 로컬 코드를 실시간 반영하려면 /deps/app으로 연결합니다.
    volumes:
      - .:/deps/app 
    
    networks:
      - langgraph-net
    
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  # 2. 체크포인트 저장용 DB
  postgres:
    image: postgres:17
    ports:
      - "5432:5432" 
    environment:
      - POSTGRES_PASSWORD=1234
      - POSTGRES_DB=postgres
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - langgraph-net
    volumes:
      - pgdata:/var/lib/postgresql/data

  # 3. 작업 큐 관리용 Redis
  redis:
    image: redis:7
    ports:
      - "6379:6379"  # 이 줄을 추가하세요!
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - langgraph-net

networks:
  langgraph-net:
    driver: bridge

volumes:
  pgdata: